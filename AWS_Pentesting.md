# Introduction to AWS Pentesting [Link](https://academy.simplycyber.io/courses/enrolled/2760561)

# 1 Welcome To The Course
- Basics of cloud usage

# 2 Configuring the Lab Environment
- Create AWS free tier account
- Budget alerts
- Install AWS CLI
- Enabling Autocomplete for the AWS CLI
- Installing [cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
- Installing Pacu
```bash
# Enabling Autocomplete for the AWS CLI
echo -e '\nexport PATH=/usr/local/bin/:$PATH\nautoload bashcompinit && bashcompinit\nautoload -Uz compinit && compinit\ncomplete -C "/usr/local/bin/aws_completer" aws' >> ~/.zshrc
source ~/.zshrc
aws s[Press Tab]

# try to install the cloudgoat and pacu with pipx
pipx install git+<URL>.git
```

# 3 IAM The Admin Now (Understanding IAM in AWS)
- This section kicks off our deep dive into Identity and Access Management (IAM) in AWS. Whether you’re completely new to IAM or just need a refresher, this will give you the foundation you need before jumping into the hands-on labs.

### Concept of IAM
- **Users** - Users represent people or applications. They have long-term credentials like usernames, passwords and access keys.
- **Groups** - Groups are just a way to manage permissions for multiple users at once. (Backend engineers are grouped into one, then attach to the required resources.)
- **Policies** - Policies are what a user, group or role can and can't do. They're written in JSON and attached to IAM entities. There are two kinds.
    - **Managed Policies** - Reusable across users and groups. These are easier to manage and scale.
    - **Inline policies** - Attached directly to one user or group. These are harder to track and often the source of privilege escalation bugs in a real-world environment.
- **Roles** - Roles are like users but without long-term credentials. You assume a role temporarily, and AWS gives you credentils that expire after a set time.

### Why IAM Matters for Pentesting
- Misconfiguration (Not a zero-day attacks)
    - **Privilege Escalation** Can I go from a low-privilege user to an admin? This is the most common and most impactful finding in cloud environments.
    - **Lateral Movement** - Even if I can’t get admin access, can I move sideways into another user, role, or resource with sensitive access—like an S3 bucket full of data?
    - **Data Exfiltration** - Can I take over a Lambda function and send data to my own server?
    - **Persistence** - If I can create access keys for another user, I can quietly backdoor their account without changing their password. That kind of access is hard to detect unless you’ve got solid logging and alerting in place.

> In one assessment, I ran into a policy that looked secure at first glance. It denied me from attaching the AdministratorAccess policy. But when I looked closer, I noticed it allowed me to do `iam:*` on `*` —except for that one explicit deny. So instead of attaching AdministratorAccess, I just created my own policy with full permissions, gave it a different name, and attached it. Full admin access—game over.

### What to Watch For
- When you’re reviewing IAM permissions, here are four things you should always check:
    - Users with **excessive permissions**
    - Roles that can be **assumed**
    - Policies that use wildcards (e.g., `"Action": "*"` or `"Resource": "*"`)
    - Services or **Lambda** functions with elevated permissions that you can potentially abuse

```bash
{
"Version": "2012-10-17",
"Statement": [
    {
    "Effect": "Deny",
    "Action": [
            "iam:PassRole",
            "iam:AttachRolePolicy",
            "iam:PutRolePolicy",
            "iam:Update AssumeRolePolicy"
    ],
    "Resource": "arn:aws:iam::*:role/Administrator"
    },
    {
        "Effect": "Allow",
        "Action": "iam:*",
        "Resource": "*"
    }
 ]
}
```

### IAM Enumeration Cheat Sheet
1. List IAM Users ```aws iam list-isers```
2. Get User Permissions
    a. List attached managed policies ```aws iam list-attached-user-policies --user-name [user-name]```
    b. List inline policies ```aws iam list-user-policies --user-name [user-name]```
    c. Get inline policy details ```aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]```
3. List IAM Groups and permissions
     a. List groups for a user ```aws iam list-groups-for-user --user-name [user-name]```
     b. List group policies ```aws iam list-attached-group-policies --group-name [group-name] , aws iam list-group-policies --group-name [group-name]```
     c. Get inline group policy details ```aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]```
4.  List IAM Roles and Permissions
    a. List all roles ```aws iam list-roles```
    b. Get role details (trust policy) ```aws iam get-role --role-name [role-name]```
    c. List attached policies ```aws iam list-attached-role-policies --role-name [role-name]```
    d. List inline policies ```aws iam list-role-policies --role-name [role-name]```
    e. Get inline role policy details ```aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]```
5. Get and Decode Policy Documents
- Get a managed policy document(by ARN or name)
```bash
aws iam get-policy --policy-arn [policy-arn]
aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]
```
6. View Full IAM Snapshot
- Dump all IAM permissions (users, roles, groups, policies)
```bash
aws iam get-account-authorization-details
```
> Use this to build a full IAM permissions map. Add `--filter` to target roles/users/groups specifically.
- Lab Commands
```bash
# username and policyname only for this lab free to change accordingly
aws configure --profile cybr
aws sts get-caller-identity --profile cybr
aws iam get-user --profile cybr
aws iam get-account-authorization-details  --profile cybr
aws iam list-usera --profile cybr
aws iam list-users --profile cybr
aws iam list-access-keys --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam list-user-attached-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-attached-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-groups --profile cybr
aws iam list-groups-for-user --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --policy-name introduction-to-aws-iam-enumeration-1747259538516-devs-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --policy-name introduction-to-aws-iam-enumeration-1747259538516-infra-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developer --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-roles --profile cybr
aws iam list-roles --query "Roles[?RoleName=='SupportRole']" --profile cybr
aws iam list-role-policies --role-name SupportRole --profile cybr
aws iam get-role-policy --role-name SupportRole --policy-name AllowS3FullAccessForRole --profile cybr

```
